<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BackLog ‚Äì Know your pain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #fdfaf5;
      --bg-card: #ffffff;
      --border-soft: #e2e2e2;
      --text-main: #111111;
      --text-muted: #888888;
      --accent: #ffd86b;
      --accent-soft: #fff3c2;
      --red: #ff4b4b;
      --yellow: #ffd86b;
      --green: #4caf50;
      --shadow-soft: 0 10px 24px rgba(0, 0, 0, 0.06);
      --radius-card: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Rounded",
        "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background: #f3eee4;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 28px 16px;
      font-size: 18px;
    }

    .phone-frame {
      width: 100%;
      max-width: 1200px;
      height: calc(100vh - 40px);
      background: #f9f3e7;
      border-radius: 24px;
      padding: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .inner-screen {
      width: 100%;
      height: 100%;
      background: var(--bg-main);
      border-radius: 18px;
      padding: 18px 20px 20px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 4px 2px 12px;
    }

    .title {
      font-weight: 800;
      font-size: 28px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 16px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .code-tag {
      margin-top: 6px;
      font-size: 13px;
      color: #a18c64;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed #decba0;
      display: inline-block;
      cursor: pointer;
      background: #fffaf0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 4px 12px;
      gap: 10px;
    }

    .main-header {
      margin-top: 4px;
    }

    .main-header .tabs {
      flex: 1;
    }

    .tabs {
      background: #f1e7d7;
      border-radius: var(--radius-pill);
      padding: 6px;
      display: flex;
      gap: 6px;
      min-width: 220px;
    }

    .tab {
      flex: 1;
      text-align: center;
      font-size: 20px;
      padding: 10px 18px;
      border-radius: var(--radius-pill);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, color 0.2s, transform 0.1s;
      color: #7f6b4a;
    }

    .tab.active {
      background: #fff7e4;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.12);
      color: #4a3a22;
      font-weight: 600;
      transform: translateY(-1px);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 10px 6px 0;
      scrollbar-width: thin;
      scrollbar-color: #d4c6aa transparent;
    }

    .content::-webkit-scrollbar {
      width: 8px;
    }
    .content::-webkit-scrollbar-thumb {
      background: #d4c6aa;
      border-radius: 999px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #4a3a22;
    }

    .section-subtitle {
      font-size: 15px;
      color: var(--text-muted);
    }

    .btn-primary {
      background: #f1c24b;
      border-radius: var(--radius-pill);
      border: none;
      padding: 8px 18px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.18);
    }

    #btn-add-entry {
      width: 56px;
      height: 44px;
      border-radius: 999px;
      font-size: 26px;
      padding: 0;
    }

    .btn-ghost {
      background: transparent;
      border-radius: var(--radius-pill);
      border: 1px solid #e4d3b5;
      padding: 7px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-icon {
      width: 40px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid #ddd0b7;
      background: #faf3e1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .btn-icon svg {
      width: 20px;
      height: 20px;
      display: block;
    }

    .btn-icon:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
    }

    .btn-small {
      font-size: 13px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #e4d3b5;
      background: transparent;
      cursor: pointer;
    }

    .btn-small-danger {
      border-color: #e8dede;
      color: #9b6666;
      opacity: 0.8;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 12px 14px;
      margin-bottom: 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #f0e3cd;
      cursor: pointer;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-date {
      font-size: 17px;
      font-weight: 600;
      color: #6a5735;
    }

    .card-row {
      font-size: 16px;
      margin-top: 4px;
      color: #3b3121;
    }

    .bullet-list {
      margin-top: 4px;
      margin-bottom: 0;
      padding-left: 22px;
    }

    .bullet-list li {
      margin-bottom: 3px;
      white-space: pre-wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      min-width: 70px;
    }

    .pill-bad {
      background: var(--red);
    }
    .pill-meh {
      background: #f2b400;
    }
    .pill-good {
      background: var(--green);
    }
    .pill-muted {
      background: #ccc;
      color: #333;
    }

    .calendar-wrapper {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 12px 12px 10px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #f0e3cd;
      margin-bottom: 12px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .calendar-month {
      font-size: 18px;
      font-weight: 600;
      color: #4a3a22;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      font-size: 13px;
      text-align: center;
    }

    .calendar-day-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .calendar-cell {
      height: 32px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: transform 0.05s, box-shadow 0.1s, background 0.1s, color 0.1s;
      background: #f4ead8;
      color: #4a3a22;
      font-size: 14px;
    }

    .calendar-cell.empty {
      background: transparent;
      cursor: default;
    }

    .calendar-cell.selected {
      box-shadow: 0 0 0 1px #4a3a22;
    }

    .calendar-cell.bad {
      background: var(--red);
      color: #ffffff;
    }

    .calendar-cell.meh {
      background: var(--yellow);
      color: #4a3a22;
    }

    .calendar-cell.good {
      background: var(--green);
      color: #ffffff;
    }

    .calendar-legend {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }

    .day-details-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .day-details-empty {
      font-size: 14px;
      color: var(--text-muted);
      padding: 6px 2px;
    }

    #summary-section {
      margin: 14px 4px 6px;
    }

    .summary-card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 10px 12px;
      margin-bottom: 8px;
      border: 1px solid #f0e3cd;
      box-shadow: var(--shadow-soft);
      font-size: 14px;
    }

    .summary-title-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-weight: 600;
      color: #4a3a22;
    }

    .summary-sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .summary-row {
      font-size: 13px;
      margin-top: 2px;
    }

    .ideas-wrapper {
      margin-top: 6px;
    }

    .idea-form,
    .idea-card {
      background: var(--bg-card);
      padding: 12px 12px 10px;
      border-radius: var(--radius-card);
      border: 1px solid #f0e3cd;
      box-shadow: var(--shadow-soft);
      margin-bottom: 12px;
    }

    .idea-card {
      cursor: pointer;
    }

    .idea-card:hover {
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.08);
    }

    .idea-form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .idea-input,
    .idea-textarea,
    .entry-input,
    .entry-textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #e0d3bc;
      padding: 8px 10px;
      font-size: 15px;
      background: #fffdf6;
      outline: none;
      resize: vertical;
      min-height: 32px;
    }

    .idea-textarea,
    .entry-textarea {
      min-height: 70px;
    }

    .idea-input:focus,
    .idea-textarea:focus,
    .entry-input:focus,
    .entry-textarea:focus {
      border-color: #e3b340;
      box-shadow: 0 0 0 1px #ffe09a;
      background: #fffef8;
    }

    .idea-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3e311d;
    }

    .idea-body {
      font-size: 15px;
      color: #4c3d25;
      margin-bottom: 4px;
      white-space: pre-wrap;
    }

    .idea-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .idea-form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .bottom-safe {
      height: 14px;
    }

    .entry-sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.16);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }

    .entry-sheet-backdrop.active {
      display: flex;
    }

    .entry-sheet {
      width: 100%;
      max-width: 760px;
      background: var(--bg-main);
      border-radius: 20px 20px 0 0;
      padding: 14px 18px 18px;
      box-shadow: 0 -12px 32px rgba(0, 0, 0, 0.25);
      border-top: 1px solid #e4d6bf;
      max-height: 80%;
      overflow-y: auto;
      font-size: 15px;
    }

    .entry-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .entry-sheet-title {
      font-size: 18px;
      font-weight: 600;
    }

    .entry-sheet-actions {
      display: flex;
      gap: 6px;
    }

    .entry-form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 7px 0;
    }

    .pain-options {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .pain-option {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: var(--radius-pill);
      font-size: 15px;
      cursor: pointer;
      border: 1px solid transparent;
      user-select: none;
    }

    .pain-option[data-pain="bad"] {
      background: #ffe3e3;
      border-color: #ffc2c2;
      color: #b02222;
    }

    .pain-option[data-pain="meh"] {
      background: #fff3cf;
      border-color: #ffe3a6;
      color: #8a6300;
    }

    .pain-option[data-pain="good"] {
      background: #ddf7de;
      border-color: #bde8c0;
      color: #216527;
    }

    .pain-option.active {
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
      font-weight: 600;
    }

    .empty-state {
      font-size: 15px;
      color: var(--text-muted);
      padding: 10px 8px;
      border-radius: 14px;
      border: 1px dashed #e3d3b8;
      background: #fdf6e9;
      text-align: center;
    }

    /* Intro overlay */
    .intro-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #fffaf0, #e2d5c0);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 100;
    }

    .intro-card {
      max-width: 480px;
      width: 100%;
      background: #fffdf6;
      border-radius: 26px;
      padding: 24px 22px 20px;
      box-shadow: 0 22px 44px rgba(0, 0, 0, 0.22);
      border: 1px solid #f0e3cd;
      position: relative;
    }

    .intro-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .intro-title {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .intro-subtitle {
      font-size: 15px;
      color: #7a6a4c;
      margin-bottom: 8px;
      margin-top: 4px;
    }

    .intro-bullets {
      font-size: 14px;
      color: #55442a;
      margin-bottom: 14px;
    }

    .intro-bullets li {
      margin-left: 20px;
      margin-bottom: 4px;
    }

    .intro-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #a18c64;
      margin-bottom: 4px;
    }

    .code-input {
      width: 100%;
      border-radius: 18px;
      border: 1px solid #e0d3bc;
      padding: 12px 14px;
      font-size: 22px;
      background: #fffef8;
      outline: none;
      text-align: center;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      font-variant-numeric: tabular-nums;
    }

    .code-input:focus {
      border-color: #e3b340;
      box-shadow: 0 0 0 1px #ffe09a;
      background: #ffffff;
    }

    .code-hint {
      font-size: 13px;
      color: #a18c64;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .code-explain {
      font-size: 13px;
      color: #7e6b4a;
      margin-bottom: 8px;
    }

    .code-error {
      font-size: 13px;
      color: #c03b3b;
      min-height: 16px;
      margin-bottom: 8px;
    }

    .intro-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .intro-small {
      font-size: 12px;
      color: #9c8c6d;
    }

    .lang-switch {
      display: inline-flex;
      gap: 8px;
    }

    .lang-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid #e0d3bc;
      background: #fff7e4;
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
    }

    .lang-btn.active {
      border-color: #e3b340;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      body {
        padding: 12px 4px;
        align-items: center;
        background: #e5e5ea;
        font-size: 15px;
      }

      .phone-frame {
        max-width: 420px;
        height: min(800px, 92vh);
        border-radius: 40px;
        padding: 16px;
      }

      .inner-screen {
        border-radius: 28px;
        padding: 12px 12px 16px;
      }

      .title {
        font-size: 24px;
      }

      .section-title {
        font-size: 18px;
      }

      .tabs {
        max-width: 260px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-actions {
        align-self: flex-end;
      }

      .intro-card {
        padding: 20px 18px 18px;
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
        align-items: flex-start;
      }
      .phone-frame {
        box-shadow: none;
        border-radius: 0;
        height: auto;
        padding: 0;
        border: none;
      }
      .inner-screen {
        border-radius: 0;
        padding: 16px;
        height: auto;
      }
      .tabs,
      .intro-overlay,
      .entry-sheet-backdrop,
      .btn-primary,
      .btn-icon,
      .btn-ghost,
      .btn-small,
      .btn-small-danger {
        display: none !important;
      }
      .content {
        overflow: visible;
      }
    }
  </style>
</head>
<body>
  <!-- Intro / Passcode overlay -->
  <div id="intro-overlay" class="intro-overlay">
    <div class="intro-card">
      <div class="intro-header-row">
        <div>
          <div class="intro-title" data-i18n="intro_title">BackLog</div>
        </div>
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="en">üá∫üá∏</button>
          <button class="lang-btn" data-lang="ko">üá∞üá∑</button>
        </div>
      </div>

      <div class="intro-subtitle" data-i18n="intro_subtitle">
        A tiny notebook for your back.
      </div>

      <ul class="intro-bullets" id="intro-bullets">
        <!-- Filled by JS per language -->
      </ul>

      <div class="code-explain" data-i18n="intro_explain">
        Pick any access code. Anyone with the same code sees the same log.
      </div>

      <div class="intro-label" data-i18n="intro_label_access">Access code</div>
      <input
        id="code-input"
        class="code-input"
        maxlength="7"
        placeholder="1234ABC"
        data-i18n-placeholder="code_placeholder"
      />
      <div
        class="code-hint"
        id="code-hint"
        data-i18n="intro_hint"
      >
        4 digits + 3 letters (e.g. 2025BPK).
      </div>
      <div id="code-error" class="code-error"></div>

      <div class="intro-footer">
        <div class="intro-small" data-i18n="intro_small">
          No account. Just remember your code.
        </div>
        <button
          id="btn-enter-app"
          class="btn-primary"
          data-i18n="intro_button_enter"
        >
          Enter
        </button>
      </div>
    </div>
  </div>

  <div class="phone-frame">
    <div class="inner-screen">
      <div class="top-bar">
        <div>
          <div class="title">BackLog</div>
          <div class="subtitle" data-i18n="app_subtitle">Know your pain</div>
          <div id="code-tag" class="code-tag" style="display:none;">
            Code: ----
          </div>
        </div>
      </div>

      <div class="section-header main-header">
        <div class="tabs">
          <div class="tab active" data-tab="entries" title="Entries">‚úèÔ∏è</div>
          <div class="tab" data-tab="calendar" title="Calendar">üìÖ</div>
          <div class="tab" data-tab="ideas" title="Ideas">üí°</div>
        </div>

        <div class="header-actions no-print" id="entries-header-actions">
          <button id="btn-add-entry" class="btn-primary">+</button>
        </div>
      </div>

      <div class="content">
        <!-- Entries Tab -->
        <div id="tab-entries" class="tab-panel">
          <div class="section-header">
            <div>
              <div class="section-title" data-i18n="entries_title">
                All Entries
              </div>
              <div class="section-subtitle" data-i18n="entries_subtitle">
                Your daily BackLog
              </div>
            </div>
          </div>
          <div id="entries-list"></div>

          <!-- Summary Section -->
          <div id="summary-section">
            <div class="section-header">
              <div>
                <div class="section-title" data-i18n="summary_title">
                  Weekly summary
                </div>
                <div class="section-subtitle" data-i18n="summary_subtitle">
                  Patterns you can share with your doctor
                </div>
              </div>
              <!-- Export icon here -->
              <button id="btn-export" class="btn-icon" title="Download text file">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 3v11" stroke="#444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                  <path d="M8 10l4 4 4-4" stroke="#444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                  <path d="M5 14h14v4a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-4z" fill="#444"/>
                </svg>
              </button>
            </div>
            <div id="summary-container"></div>
          </div>
        </div>

        <!-- Calendar Tab -->
        <div id="tab-calendar" class="tab-panel" style="display: none;">
          <div class="section-header">
            <div>
              <div class="section-title" data-i18n="calendar_title">
                Calendar View
              </div>
              <div class="section-subtitle" data-i18n="calendar_subtitle">
                Tap a day to view or add
              </div>
            </div>
            <button
              class="btn-ghost no-print"
              id="btn-today"
              data-i18n="btn_today"
            >
              Today
            </button>
          </div>

          <div class="calendar-wrapper">
            <div class="calendar-header">
              <button class="btn-ghost no-print" id="btn-prev-month">‚Äπ</button>
              <div class="calendar-month" id="calendar-month-label"></div>
              <button class="btn-ghost no-print" id="btn-next-month">‚Ä∫</button>
            </div>

            <div class="calendar-grid" id="calendar-grid"></div>

            <div class="calendar-legend">
              <div class="legend-item">
                <span class="legend-color" style="background: #fecaca;"></span>
                <span data-i18n="legend_bad">Bad</span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #fde68a;"></span>
                <span data-i18n="legend_meh">Meh</span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #bbf7d0;"></span>
                <span data-i18n="legend_good">Good</span>
              </div>
            </div>
          </div>

          <div>
            <div class="day-details-title" id="day-details-title">Today</div>
            <div id="day-details-container"></div>
          </div>
        </div>

        <!-- Ideas Tab -->
        <div id="tab-ideas" class="tab-panel" style="display: none;">
          <div class="section-header">
            <div>
              <div class="section-title" data-i18n="ideas_title">
                Ideas for Recovery
              </div>
              <div class="section-subtitle" data-i18n="ideas_subtitle">
                Doctors, stretches, procedures‚Ä¶
              </div>
            </div>
          </div>

          <div class="ideas-wrapper">
            <div class="idea-form no-print">
              <div class="idea-form-row">
                <div class="section-subtitle" data-i18n="ideas_label_title">
                  Idea title
                </div>
                <input
                  id="idea-title-input"
                  class="idea-input"
                  data-i18n-placeholder="ideas_title_placeholder"
                />
              </div>
              <div class="idea-form-row">
                <div class="section-subtitle" data-i18n="ideas_label_details">
                  Details
                </div>
                <textarea
                  id="idea-body-input"
                  class="idea-textarea"
                  data-i18n-placeholder="ideas_body_placeholder"
                ></textarea>
              </div>
              <div class="idea-form-actions">
                <button
                  id="btn-add-idea"
                  class="btn-primary"
                  data-i18n="btn_save_idea"
                >
                  Save Idea
                </button>
                <button
                  id="btn-delete-idea"
                  class="btn-small btn-small-danger"
                  style="display:none;"
                  data-i18n="btn_delete_idea"
                >
                  üóë Delete
                </button>
              </div>
            </div>

            <div id="ideas-list"></div>
          </div>
        </div>

        <div class="bottom-safe no-print"></div>
      </div>

      <!-- Entry Sheet -->
      <div id="entry-sheet-backdrop" class="entry-sheet-backdrop no-print">
        <div class="entry-sheet">
          <div class="entry-sheet-header">
            <button
              id="btn-cancel-entry"
              class="btn-ghost"
              data-i18n="btn_cancel_entry"
            >
              Cancel
            </button>
            <div
              class="entry-sheet-title"
              id="entry-sheet-title"
              data-i18n="entry_sheet_new"
            >
              New Entry
            </div>
            <div class="entry-sheet-actions">
              <button
                id="btn-save-entry"
                class="btn-primary"
                data-i18n="btn_save_entry"
              >
                Save
              </button>
            </div>
          </div>

          <div
            class="section-subtitle"
            style="margin-bottom: 6px;"
            data-i18n="entry_sheet_hint"
          >
            Fill this out at the end of your day.
          </div>

          <div class="entry-form-row">
            <div class="section-subtitle" data-i18n="entry_label_date">Date</div>
            <input type="date" id="entry-date-input" class="entry-input" />
          </div>

          <div class="entry-form-row">
            <div
              class="section-subtitle"
              data-i18n="entry_label_activity"
            >
              Activity / Symptom
            </div>
            <textarea
              id="entry-activity-input"
              class="entry-textarea"
              data-i18n-placeholder="entry_activity_placeholder"
            ></textarea>
          </div>

          <div class="entry-form-row">
            <div
              class="section-subtitle"
              data-i18n="entry_label_treatment"
            >
              Treatment / Meds
            </div>
            <textarea
              id="entry-treatment-input"
              class="entry-textarea"
              data-i18n-placeholder="entry_treatment_placeholder"
            ></textarea>
          </div>

          <div class="entry-form-row">
            <div
              class="section-subtitle"
              data-i18n="entry_label_feeling"
            >
              Feeling / Reflection
            </div>
            <textarea
              id="entry-feeling-input"
              class="entry-textarea"
              data-i18n-placeholder="entry_feeling_placeholder"
            ></textarea>
          </div>

          <div class="entry-form-row">
            <div
              class="section-subtitle"
              data-i18n="entry_label_pain"
            >
              Overall Pain
            </div>
            <div class="pain-options" id="pain-options">
              <div
                class="pain-option"
                data-pain="bad"
                data-i18n="pain_bad"
              >
                Bad
              </div>
              <div
                class="pain-option"
                data-pain="meh"
                data-i18n="pain_meh"
              >
                Meh
              </div>
              <div
                class="pain-option"
                data-pain="good"
                data-i18n="pain_good"
              >
                Good
              </div>
            </div>
          </div>

          <div
            class="entry-form-row no-print"
            id="entry-delete-row"
            style="display:none; margin-top:10px;"
          >
            <button
              id="btn-delete-entry"
              class="btn-small btn-small-danger"
              data-i18n="btn_delete_entry"
            >
              üóë Delete entry
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    "use strict";

    const SUPABASE_URL = "https://upiobealvympxbypfmkc.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaW9iZWFsdnltcHhieXBmbWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzYxNDIsImV4cCI6MjA3ODk1MjE0Mn0.mLvGyy-eMWr-ow2b2USMg7PXKq2EUfK1fyJEsdGThKw";

    const PAIN_SCORE = { good: 1, meh: 2, bad: 3 };

    let supabaseClient = null;
    let entries = [];
    let ideas = [];

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = formatDateKey(new Date());
    let selectedPain = null;
    let editingEntryId = null;
    let editingIdeaId = null;
    let currentCode = null;

    let currentLang = "en";

    const translations = {
      en: {
        intro_title: "BackLog",
        intro_subtitle: "A tiny notebook for your back.",
        intro_bullets: [
          "Log your day in under a minute.",
          "See your pain as colors on a calendar.",
          "Share this log with your doctor or AI using a code."
        ],
        intro_explain:
          "Pick any access code. Anyone with the same code sees the same log.",
        intro_label_access: "Access code",
        code_placeholder: "1234ABC",
        intro_hint:
          "4 digits + 3 letters (e.g. 2025BPK). Use any code you like.",
        intro_small: "No account. Just remember your code.",
        intro_button_enter: "Enter",
        intro_error_format:
          "Please enter 4 digits + 3 letters (e.g. 1234ABC).",
        app_subtitle: "Know your pain",
        entries_title: "All Entries",
        entries_subtitle: "Your daily BackLog",
        summary_title: "Weekly summary",
        summary_subtitle: "Patterns you can share with your doctor",
        calendar_title: "Calendar View",
        calendar_subtitle: "Tap a day to view or add",
        ideas_title: "Ideas for Recovery",
        ideas_subtitle: "Doctors, stretches, procedures‚Ä¶",
        ideas_label_title: "Idea title",
        ideas_label_details: "Details",
        ideas_title_placeholder: "New doctor, clinic, exercise‚Ä¶",
        ideas_body_placeholder: "Write any idea that might help your back.",
        btn_save_idea: "Save Idea",
        btn_delete_idea: "Delete",
        btn_cancel_entry: "Cancel",
        btn_save_entry: "Save",
        btn_delete_entry: "Delete entry",
        entry_sheet_new: "New Entry",
        entry_sheet_edit: "Edit Entry",
        entry_sheet_hint: "Fill this out at the end of your day.",
        entry_label_date: "Date",
        entry_label_activity: "Activity / Symptom",
        entry_label_treatment: "Treatment / Meds",
        entry_label_feeling: "Feeling / Reflection",
        entry_label_pain: "Overall Pain",
        entry_activity_placeholder: "What did you do? What hurt?",
        entry_treatment_placeholder: "Meds, stretches, rest, etc.",
        entry_feeling_placeholder: "How did it feel? Any thoughts?",
        pain_bad: "Bad",
        pain_meh: "Meh",
        pain_good: "Good",
        legend_bad: "Bad",
        legend_meh: "Meh",
        legend_good: "Good",
        btn_today: "Today",
        entries_empty:
          "No entries yet. Tap ‚Äú+‚Äù to add your first note.",
        summary_empty:
          "Once you add entries, you‚Äôll see weekly pain patterns here.",
        ideas_empty:
          "No ideas yet. Use this space for doctors, stretches, procedures, or anything that might help your back.",
        day_empty:
          "No entry for this day yet. Tap the date again to add one.",
        idea_untitled: "(Untitled idea)",
        idea_saved_on: "Saved on",
        export_title: "BackLog export",
        export_no_entries: "(No entries recorded)",
        export_no_ideas: "(No ideas saved)",
        export_entries_header: "=== Entries ===",
        export_ideas_header: "=== Ideas ===",
        export_entry: "Entry",
        export_idea: "Idea",
        export_date: "Date",
        export_logged_at: "Logged at",
        export_overall_pain: "Overall pain",
        export_activity: "Activity / Symptom",
        export_treatment: "Treatment / Meds",
        export_feeling: "Feeling / Reflection",
        export_title_label: "Title",
        export_saved_at: "Saved at",
        export_details: "Details"
      },
      ko: {
        intro_title: "BackLog",
        intro_subtitle: "ÌóàÎ¶¨ ÏùºÍ∏∞Î•º ÏúÑÌïú ÏûëÏùÄ ÎÖ∏Ìä∏.",
        intro_bullets: [
          "ÌïòÎ£®Î•º 1Î∂Ñ ÏïàÏóê Í∏∞Î°ùÌï¥Ïöî.",
          "ÌÜµÏ¶ù Ï†ïÎèÑÎ•º ÏÉâÍπî Îã¨Î†•ÏúºÎ°ú ÌïúÎààÏóê Î¥êÏöî.",
          "ÏΩîÎìúÎßå Í≥µÏú†ÌïòÎ©¥ ÏùòÏÇ¨ÎÇò AIÏôÄ Í∞ôÏù¥ Î≥º Ïàò ÏûàÏñ¥Ïöî."
        ],
        intro_explain:
          "Ï†ëÍ∑º ÏΩîÎìúÎäî ÏïÑÎ¨¥ Ïà´Ïûê¬∑ÏòÅÎ¨∏ Ï°∞Ìï©Ïù¥Î©¥ ÎèºÏöî. Í∞ôÏùÄ ÏΩîÎìúÎ•º Ïì∞Î©¥ Í∞ôÏùÄ ÏùºÍ∏∞Î•º Ìï®Íªò Î≥º Ïàò ÏûàÏñ¥Ïöî.",
        intro_label_access: "Ï†ëÍ∑º ÏΩîÎìú",
        code_placeholder: "1234ABC",
        intro_hint:
          "Ïà´Ïûê 4ÏûêÎ¶¨ + ÏòÅÎ¨∏ 3ÏûêÎ¶¨ (Ïòà: 2025BPK). ÎßàÏùåÏóê ÎìúÎäî ÏΩîÎìúÎ•º ÎßåÎìúÏÑ∏Ïöî.",
        intro_small: "ÌöåÏõêÍ∞ÄÏûÖ¬∑Î°úÍ∑∏Ïù∏ ÏóÜÏù¥, ÏΩîÎìúÎßå Í∏∞ÏñµÌïòÎ©¥ Îê©ÎãàÎã§.",
        intro_button_enter: "Îì§Ïñ¥Í∞ÄÍ∏∞",
        intro_error_format:
          "Ïà´Ïûê 4ÏûêÎ¶¨ + ÏòÅÎ¨∏ 3ÏûêÎ¶¨ ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (Ïòà: 1234ABC)",
        app_subtitle: "ÌÜµÏ¶ùÏùÑ ÏïåÎ©¥ ÎßàÏùåÏù¥ Ìé∏Ìï¥Ï†∏Ïöî",
        entries_title: "Ï†ÑÏ≤¥ Í∏∞Î°ù",
        entries_subtitle: "Ïò§ÎäòÏùò ÌóàÎ¶¨ ÏùºÍ∏∞",
        summary_title: "Ï£ºÍ∞Ñ ÏöîÏïΩ",
        summary_subtitle: "ÏùòÏÇ¨ÏóêÍ≤å Î≥¥Ïó¨Ï£ºÍ∏∞ Ï¢ãÏùÄ Ìå®ÌÑ¥ Ï†ïÎ¶¨",
        calendar_title: "Îã¨Î†• Î≥¥Í∏∞",
        calendar_subtitle: "ÎÇ†ÏßúÎ•º ÎàåÎü¨ Í∏∞Î°ùÏùÑ Î≥¥Í≥† Ï∂îÍ∞ÄÌï¥Ïöî",
        ideas_title: "ÌóàÎ¶¨ ÌöåÎ≥µ ÏïÑÏù¥ÎîîÏñ¥",
        ideas_subtitle: "Î≥ëÏõê, Ïö¥Îèô, ÏãúÏà† Îì± Îñ†Ïò§Î•¥Îäî Í≤ÉÎì§",
        ideas_label_title: "ÏïÑÏù¥ÎîîÏñ¥ Ï†úÎ™©",
        ideas_label_details: "ÎÇ¥Ïö©",
        ideas_title_placeholder: "ÏÉà Î≥ëÏõê, Ïö¥Îèô, ÏãúÏà† ÏïÑÏù¥ÎîîÏñ¥ Îì±",
        ideas_body_placeholder: "ÌóàÎ¶¨Ïóê ÎèÑÏõÄÏù¥ Îê† Í≤É Í∞ôÏùÄ ÏÉùÍ∞ÅÏùÑ Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî.",
        btn_save_idea: "ÏïÑÏù¥ÎîîÏñ¥ Ï†ÄÏû•",
        btn_delete_idea: "ÏÇ≠Ï†ú",
        btn_cancel_entry: "Ï∑®ÏÜå",
        btn_save_entry: "Ï†ÄÏû•",
        btn_delete_entry: "Í∏∞Î°ù ÏÇ≠Ï†ú",
        entry_sheet_new: "ÏÉà Í∏∞Î°ù",
        entry_sheet_edit: "Í∏∞Î°ù ÏàòÏ†ï",
        entry_sheet_hint: "ÌïòÎ£®Î•º ÎßàÎ¨¥Î¶¨ÌïòÎ©¥ÏÑú Í∞ÑÎã®Ìûà Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî.",
        entry_label_date: "ÎÇ†Ïßú",
        entry_label_activity: "ÌôúÎèô / Ï¶ùÏÉÅ",
        entry_label_treatment: "ÏπòÎ£å / ÏïΩ",
        entry_label_feeling: "ÎäêÎÇå / Î©îÎ™®",
        entry_label_pain: "Ïò§ÎäòÏùò ÌÜµÏ¶ù",
        entry_activity_placeholder: "Î¨¥Ïä® ÌôúÎèôÏùÑ ÌñàÍ≥†, Ïñ¥ÎîîÍ∞Ä ÏïÑÌå†ÎÇòÏöî?",
        entry_treatment_placeholder: "Î≥µÏö©Ìïú ÏïΩ, Ïä§Ìä∏Î†àÏπ≠, Ìú¥Ïãù Îì±",
        entry_feeling_placeholder: "Ïò§Îäò Î™∏ ÏÉÅÌÉúÏôÄ ÎäêÎÇå, ÏÉùÍ∞ÅÎì§",
        pain_bad: "Ïã¨Ìï®",
        pain_meh: "Î≥¥ÌÜµ",
        pain_good: "ÏñëÌò∏",
        legend_bad: "Ïã¨Ìï®",
        legend_meh: "Î≥¥ÌÜµ",
        legend_good: "ÏñëÌò∏",
        btn_today: "Ïò§Îäò",
        entries_empty:
          "ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏñ¥Ïöî. ÏúÑÏ™Ω ‚Äú+‚Äù Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï≤´ Í∏∞Î°ùÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî.",
        summary_empty:
          "Í∏∞Î°ùÏù¥ ÏåìÏù¥Î©¥ Ïó¨Í∏∞ÏóêÏÑú Ï£ºÍ∞Ñ ÌÜµÏ¶ù Ìå®ÌÑ¥ÏùÑ Î≥º Ïàò ÏûàÏñ¥Ïöî.",
        ideas_empty:
          "ÏïÑÏßÅ ÏïÑÏù¥ÎîîÏñ¥Í∞Ä ÏóÜÏñ¥Ïöî. Î≥ëÏõê, Ïö¥Îèô, ÏãúÏà† Îì± Îñ†Ïò§Î•¥Îäî Í≤ÉÏùÑ Ï†ÅÏñ¥ÎëêÏÑ∏Ïöî.",
        day_empty:
          "Ïù¥ ÎÇ†ÏßúÏóêÎäî ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏñ¥Ïöî. ÎÇ†ÏßúÎ•º Îã§Ïãú ÎàåÎü¨ÏÑú Í∏∞Î°ùÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî.",
        idea_untitled: "(Ï†úÎ™© ÏóÜÎäî ÏïÑÏù¥ÎîîÏñ¥)",
        idea_saved_on: "Ï†ÄÏû• ÏãúÍ∞Å",
        export_title: "BackLog ÎÇ¥Î≥¥ÎÇ¥Í∏∞",
        export_no_entries: "(Ï†ÄÏû•Îêú Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.)",
        export_no_ideas: "(Ï†ÄÏû•Îêú ÏïÑÏù¥ÎîîÏñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.)",
        export_entries_header: "=== ÌÜµÏ¶ù Í∏∞Î°ù ===",
        export_ideas_header: "=== ÏïÑÏù¥ÎîîÏñ¥ ===",
        export_entry: "Í∏∞Î°ù",
        export_idea: "ÏïÑÏù¥ÎîîÏñ¥",
        export_date: "ÎÇ†Ïßú",
        export_logged_at: "Í∏∞Î°ù ÏãúÍ∞Ñ",
        export_overall_pain: "Ïò§ÎäòÏùò ÌÜµÏ¶ù",
        export_activity: "ÌôúÎèô / Ï¶ùÏÉÅ",
        export_treatment: "ÏπòÎ£å / ÏïΩ",
        export_feeling: "ÎäêÎÇå / Î©îÎ™®",
        export_title_label: "Ï†úÎ™©",
        export_saved_at: "Ï†ÄÏû• ÏãúÍ∞Å",
        export_details: "ÎÇ¥Ïö©"
      }
    };

    function applyTranslations() {
      const t = translations[currentLang];

      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (t[key]) el.textContent = t[key];
      });

      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (t[key]) el.setAttribute("placeholder", t[key]);
      });

      const bulletsEl = document.getElementById("intro-bullets");
      if (bulletsEl && Array.isArray(t.intro_bullets)) {
        bulletsEl.innerHTML = t.intro_bullets
          .map((line) => `<li>${line}</li>`)
          .join("");
      }

      const entrySheetTitle = document.getElementById("entry-sheet-title");
      if (entrySheetTitle && editingEntryId) {
        entrySheetTitle.textContent = t.entry_sheet_edit || "Edit Entry";
      } else if (entrySheetTitle) {
        entrySheetTitle.textContent = t.entry_sheet_new || "New Entry";
      }
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function parseDateFromKey(dateStr) {
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function formatDisplayDate(dateStr) {
      const d = parseDateFromKey(dateStr);
      const opts = { month: "short", day: "numeric", year: "numeric" };
      return d.toLocaleDateString(undefined, opts);
    }

    function formatDisplayDateShort(dateStr) {
      const d = parseDateFromKey(dateStr);
      const opts = { month: "short", day: "numeric" };
      return d.toLocaleDateString(undefined, opts);
    }

    function painToPillClass(pain) {
      if (pain === "bad") return "pill-bad";
      if (pain === "meh") return "pill-meh";
      if (pain === "good") return "pill-good";
      return "pill-muted";
    }

    function painToLabel(pain) {
      const t = translations[currentLang];
      if (pain === "bad") return t.pain_bad || "Bad";
      if (pain === "meh") return t.pain_meh || "Meh";
      if (pain === "good") return t.pain_good || "Good";
      return "N/A";
    }

    function sortEntries() {
      entries.sort((a, b) => {
        if (a.date === b.date) {
          return new Date(b.created_at) - new Date(a.created_at);
        }
        return a.date < b.date ? 1 : -1;
      });
    }

    async function loadData() {
      if (!supabaseClient || !currentCode) return;

      const { data: entriesData, error: entriesError } = await supabaseClient
        .from("entries")
        .select("*")
        .eq("code", currentCode)
        .order("date", { ascending: false })
        .order("created_at", { ascending: false });

      if (entriesError) {
        console.error("Load entries error:", entriesError);
        entries = [];
      } else {
        entries = entriesData || [];
      }

      const { data: ideasData, error: ideasError } = await supabaseClient
        .from("ideas")
        .select("*")
        .eq("code", currentCode)
        .order("created_at", { ascending: false });

      if (ideasError) {
        console.error("Load ideas error:", ideasError);
        ideas = [];
      } else {
        ideas = ideasData || [];
      }
    }

    function getWorstPainForDate(dateKey) {
      const todays = entries.filter((e) => e.date === dateKey);
      if (todays.length === 0) return null;
      if (todays.some((e) => e.pain === "bad")) return "bad";
      if (todays.some((e) => e.pain === "meh")) return "meh";
      if (todays.some((e) => e.pain === "good")) return "good";
      return null;
    }

    async function deleteEntry(entryId) {
      if (!confirm("Delete this entry? This cannot be undone.")) return;
      if (!supabaseClient) return;

      const { error } = await supabaseClient
        .from("entries")
        .delete()
        .eq("id", entryId)
        .eq("code", currentCode);

      if (error) {
        console.error("Delete entry error:", error);
        alert("Failed to delete entry: " + (error.message || "Unknown error"));
        return;
      }

      entries = entries.filter((e) => e.id !== entryId);
      sortEntries();
      renderEntries();
      renderCalendar();
      renderDayDetails();
      closeEntrySheet();
    }

    function makeBulletList(entry) {
      const bullets = [];
      if (entry.activity && entry.activity.trim())
        bullets.push(entry.activity.trim());
      if (entry.treatment && entry.treatment.trim())
        bullets.push(entry.treatment.trim());
      if (entry.feeling && entry.feeling.trim())
        bullets.push(entry.feeling.trim());

      if (bullets.length === 0) {
        return "<ul class='bullet-list'><li style='color:#b0a38b;'>No details recorded</li></ul>";
      }

      return (
        "<ul class='bullet-list'>" +
        bullets.map((text) => `<li>${text}</li>`).join("") +
        "</ul>"
      );
    }

    function renderEntries() {
      const t = translations[currentLang];
      sortEntries();
      const list = document.getElementById("entries-list");
      list.innerHTML = "";

      if (entries.length === 0) {
        list.innerHTML =
          '<div class="empty-state">' +
          (t.entries_empty ||
            'No entries yet. Tap ‚Äú+‚Äù to add your first note.') +
          "</div>";
        renderSummary();
        return;
      }

      entries.forEach((entry) => {
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "card-header";

        const left = document.createElement("div");
        const dateEl = document.createElement("div");
        dateEl.className = "card-date";
        dateEl.textContent = formatDisplayDate(entry.date);
        left.appendChild(dateEl);

        const painPill = document.createElement("div");
        painPill.className = `pill ${painToPillClass(entry.pain)}`;
        painPill.textContent = painToLabel(entry.pain);

        header.appendChild(left);
        header.appendChild(painPill);

        const row = document.createElement("div");
        row.className = "card-row";
        row.innerHTML = makeBulletList(entry);

        card.appendChild(header);
        card.appendChild(row);

        card.addEventListener("click", () => {
          startEditEntry(entry);
        });

        list.appendChild(card);
      });

      renderSummary();
    }

    function renderCalendar() {
      const monthLabel = document.getElementById("calendar-month-label");
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const monthName = firstDayOfMonth.toLocaleDateString(undefined, {
        month: "long",
        year: "numeric"
      });
      monthLabel.textContent = monthName;

      const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      dayLabels.forEach((d) => {
        const lbl = document.createElement("div");
        lbl.className = "calendar-day-label";
        lbl.textContent = d;
        grid.appendChild(lbl);
      });

      const startWeekday = firstDayOfMonth.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      for (let i = 0; i < startWeekday; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-cell empty";
        grid.appendChild(cell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateKey = formatDateKey(date);
        const cell = document.createElement("div");
        cell.className = "calendar-cell";

        if (dateKey === selectedDate) {
          cell.classList.add("selected");
        }

        const worstPain = getWorstPainForDate(dateKey);
        if (worstPain === "bad") {
          cell.classList.add("bad");
        } else if (worstPain === "meh") {
          cell.classList.add("meh");
        } else if (worstPain === "good") {
          cell.classList.add("good");
        }

        const num = document.createElement("div");
        num.textContent = day;
        cell.appendChild(num);

        cell.addEventListener("click", () => {
          selectedDate = dateKey;
          renderCalendar();
          renderDayDetails();

          const todays = entries.filter((e) => e.date === dateKey);
          if (todays.length === 0) {
            openEntrySheetForNew(dateKey);
          }
        });

        grid.appendChild(cell);
      }
    }

    function renderDayDetails() {
      const t = translations[currentLang];
      const container = document.getElementById("day-details-container");
      const title = document.getElementById("day-details-title");
      title.textContent = formatDisplayDate(selectedDate);

      const todays = entries.filter((e) => e.date === selectedDate);
      container.innerHTML = "";

      if (todays.length === 0) {
        container.innerHTML =
          '<div class="day-details-empty">' +
          (t.day_empty ||
            "No entry for this day yet. Tap the date again to add one.") +
          "</div>";
        return;
      }

      todays
        .slice()
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .forEach((entry) => {
          const card = document.createElement("div");
          card.className = "card";

          const header = document.createElement("div");
          header.className = "card-header";
          const painPill = document.createElement("div");
          painPill.className = `pill ${painToPillClass(entry.pain)}`;
          painPill.textContent = painToLabel(entry.pain);
          header.appendChild(painPill);

          const row = document.createElement("div");
          row.className = "card-row";
          row.innerHTML = makeBulletList(entry);

          card.appendChild(header);
          card.appendChild(row);

          card.addEventListener("click", () => {
            startEditEntry(entry);
          });

          container.appendChild(card);
        });
    }

    function renderIdeas() {
      const t = translations[currentLang];
      const list = document.getElementById("ideas-list");
      list.innerHTML = "";

      if (ideas.length === 0) {
        list.innerHTML =
          '<div class="empty-state">' +
          (t.ideas_empty ||
            "No ideas yet. Use this space for doctors, stretches, procedures, or anything that might help your back.") +
          "</div>";
        return;
      }

      const sorted = ideas
        .slice()
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      sorted.forEach((idea) => {
        const card = document.createElement("div");
        card.className = "idea-card";

        const title = document.createElement("div");
        title.className = "idea-title";
        title.textContent =
          idea.title || t.idea_untitled || "(Untitled idea)";

        const body = document.createElement("div");
        body.className = "idea-body";
        body.textContent = idea.body || "‚Äî";

        const meta = document.createElement("div");
        meta.className = "idea-meta";

        const created = new Date(idea.created_at);
        meta.textContent =
          (t.idea_saved_on || "Saved on") +
          " " +
          created.toLocaleString();

        card.appendChild(title);
        card.appendChild(body);
        card.appendChild(meta);

        card.addEventListener("click", () => {
          startEditIdea(idea);
        });

        list.appendChild(card);
      });
    }

    function getWeekStartKey(dateKey) {
      const d = parseDateFromKey(dateKey);
      const day = d.getDay();
      const diff = (day + 6) % 7;
      d.setDate(d.getDate() - diff);
      return formatDateKey(d);
    }

    function describeAverageScore(avg) {
      if (avg < 1.5) return "Mostly good days";
      if (avg < 2.25) return "Mixed pain days";
      return "Mostly difficult days";
    }

    function renderSummary() {
      const t = translations[currentLang];
      const container = document.getElementById("summary-container");
      container.innerHTML = "";

      if (entries.length === 0) {
        container.innerHTML =
          '<div class="empty-state">' +
          (t.summary_empty ||
            "Once you add entries, you‚Äôll see weekly pain patterns here.") +
          "</div>";
        return;
      }

      const weeks = {};
      entries.forEach((e) => {
        const wk = getWeekStartKey(e.date);
        if (!weeks[wk]) {
          weeks[wk] = {
            bad: 0,
            meh: 0,
            good: 0,
            total: 0,
            scoreSum: 0
          };
        }
        if (e.pain === "bad") weeks[wk].bad++;
        if (e.pain === "meh") weeks[wk].meh++;
        if (e.pain === "good") weeks[wk].good++;
        weeks[wk].total++;
        weeks[wk].scoreSum += PAIN_SCORE[e.pain] || 0;
      });

      const weekKeys = Object.keys(weeks).sort((a, b) => (a < b ? 1 : -1));

      weekKeys.forEach((wkKey) => {
        const data = weeks[wkKey];
        const avg = data.scoreSum / Math.max(data.total, 1);

        const weekStart = wkKey;
        const weekStartDate = parseDateFromKey(weekStart);
        const weekEndDate = new Date(weekStartDate);
        weekEndDate.setDate(weekEndDate.getDate() + 6);
        const rangeLabel =
          formatDisplayDateShort(weekStart) +
          " ‚Äì " +
          formatDisplayDateShort(formatDateKey(weekEndDate));

        const card = document.createElement("div");
        card.className = "summary-card";

        const titleLine = document.createElement("div");
        titleLine.className = "summary-title-line";
        const left = document.createElement("div");
        left.textContent = `Week of ${formatDisplayDateShort(weekStart)}`;
        const right = document.createElement("div");
        right.textContent = describeAverageScore(avg);
        titleLine.appendChild(left);
        titleLine.appendChild(right);

        const sub = document.createElement("div");
        sub.className = "summary-sub";
        sub.textContent = rangeLabel;

        const countsRow = document.createElement("div");
        countsRow.className = "summary-row";
        countsRow.textContent =
          `Bad: ${data.bad} | Meh: ${data.meh} | Good: ${data.good} ` +
          `(entries: ${data.total})`;

        const avgRow = document.createElement("div");
        avgRow.className = "summary-row";
        avgRow.textContent = `Average pain score (1=good, 3=bad): ${avg.toFixed(
          2
        )}`;

        card.appendChild(titleLine);
        card.appendChild(sub);
        card.appendChild(countsRow);
        card.appendChild(avgRow);

        container.appendChild(card);
      });
    }

    function showTab(tabName) {
      const tabs = document.querySelectorAll(".tab");
      const panels = document.querySelectorAll(".tab-panel");

      tabs.forEach((t) =>
        t.classList.toggle("active", t.dataset.tab === tabName)
      );
      panels.forEach((p) => {
        p.style.display = p.id === `tab-${tabName}` ? "block" : "none";
      });

      if (tabName === "calendar") {
        document.getElementById(
          "entries-header-actions"
        ).style.visibility = "hidden";
        renderCalendar();
        renderDayDetails();
      } else if (tabName === "entries") {
        document.getElementById(
          "entries-header-actions"
        ).style.visibility = "visible";
      } else {
        document.getElementById(
          "entries-header-actions"
        ).style.visibility = "hidden";
      }
    }

    function openEntrySheetForNew(dateOverride) {
      editingEntryId = null;
      const backdrop = document.getElementById("entry-sheet-backdrop");
      const t = translations[currentLang];
      const title = document.getElementById("entry-sheet-title");
      title.textContent = t.entry_sheet_new || "New Entry";

      backdrop.classList.add("active");

      const dateInput = document.getElementById("entry-date-input");
      dateInput.value =
        dateOverride || selectedDate || formatDateKey(new Date());

      document.getElementById("entry-activity-input").value = "";
      document.getElementById("entry-treatment-input").value = "";
      document.getElementById("entry-feeling-input").value = "";

      setPainSelection(null);

      document.getElementById("entry-delete-row").style.display = "none";
    }

    function startEditEntry(entry) {
      editingEntryId = entry.id;
      const backdrop = document.getElementById("entry-sheet-backdrop");
      const t = translations[currentLang];
      const title = document.getElementById("entry-sheet-title");
      title.textContent = t.entry_sheet_edit || "Edit Entry";

      backdrop.classList.add("active");

      document.getElementById("entry-date-input").value = entry.date;
      document.getElementById("entry-activity-input").value =
        entry.activity || "";
      document.getElementById("entry-treatment-input").value =
        entry.treatment || "";
      document.getElementById("entry-feeling-input").value =
        entry.feeling || "";

      setPainSelection(entry.pain || null);

      document.getElementById("entry-delete-row").style.display = "block";
    }

    function closeEntrySheet() {
      const backdrop = document.getElementById("entry-sheet-backdrop");
      backdrop.classList.remove("active");
      editingEntryId = null;
      setPainSelection(null);
      document.getElementById("entry-delete-row").style.display = "none";
      applyTranslations();
    }

    function setPainSelection(pain) {
      selectedPain = pain;
      const options = document.querySelectorAll(".pain-option");
      options.forEach((opt) => {
        opt.classList.toggle("active", opt.dataset.pain === pain);
      });
    }

    async function handleSaveEntry() {
      const t = translations[currentLang];
      const date =
        document.getElementById("entry-date-input").value ||
        formatDateKey(new Date());
      const activity = document
        .getElementById("entry-activity-input")
        .value.trim();
      const treatment = document
        .getElementById("entry-treatment-input")
        .value.trim();
      const feeling = document
        .getElementById("entry-feeling-input")
        .value.trim();

      const pain = selectedPain || "meh";

      if (!currentCode || !supabaseClient) {
        alert(
          currentLang === "ko"
            ? "Î®ºÏ†Ä Ï†ëÍ∑º ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."
            : "Please enter an access code first."
        );
        return;
      }

      if (editingEntryId) {
        const { data, error } = await supabaseClient
          .from("entries")
          .update({
            date,
            activity,
            treatment,
            feeling,
            pain
          })
          .eq("id", editingEntryId)
          .eq("code", currentCode)
          .select()
          .single();

        if (error) {
          console.error("Update entry error:", error);
          alert(
            "Failed to update entry: " + (error.message || "Unknown error")
          );
          return;
        }

        const idx = entries.findIndex((e) => e.id === editingEntryId);
        if (idx !== -1) {
          entries[idx] = data;
        }
      } else {
        const nowIso = new Date().toISOString();
        const { data, error } = await supabaseClient
          .from("entries")
          .insert([
            {
              code: currentCode,
              date,
              activity,
              treatment,
              feeling,
              pain,
              created_at: nowIso
            }
          ])
          .select()
          .single();

        if (error) {
          console.error("Insert entry error:", error);
          alert(
            "Failed to save entry: " + (error.message || "Unknown error")
          );
          return;
        }

        entries.unshift(data);
      }

      sortEntries();
      renderEntries();

      selectedDate = date;
      renderCalendar();
      renderDayDetails();

      closeEntrySheet();
    }

    function resetIdeaForm() {
      const titleInput = document.getElementById("idea-title-input");
      const bodyInput = document.getElementById("idea-body-input");
      const saveBtn = document.getElementById("btn-add-idea");
      const delBtn = document.getElementById("btn-delete-idea");

      titleInput.value = "";
      bodyInput.value = "";
      editingIdeaId = null;
      saveBtn.textContent =
        translations[currentLang].btn_save_idea || "Save Idea";
      delBtn.style.display = "none";
    }

    function startEditIdea(idea) {
      const titleInput = document.getElementById("idea-title-input");
      const bodyInput = document.getElementById("idea-body-input");
      const saveBtn = document.getElementById("btn-add-idea");
      const delBtn = document.getElementById("btn-delete-idea");
      const t = translations[currentLang];

      editingIdeaId = idea.id;
      titleInput.value = idea.title || "";
      bodyInput.value = idea.body || "";
      saveBtn.textContent = t.btn_save_idea || "Save Idea";
      delBtn.style.display = "inline-flex";

      const content = document.querySelector(".content");
      if (content) {
        content.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    async function deleteIdea(id) {
      if (
        !confirm(
          currentLang === "ko"
            ? "Ïù¥ ÏïÑÏù¥ÎîîÏñ¥Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?"
            : "Delete this idea?"
        )
      )
        return;
      if (!supabaseClient) return;

      const { error } = await supabaseClient
        .from("ideas")
        .delete()
        .eq("id", id)
        .eq("code", currentCode);

      if (error) {
        console.error("Delete idea error:", error);
        alert("Failed to delete idea: " + (error.message || "Unknown error"));
        return;
      }

      ideas = ideas.filter((i) => i.id !== id);
      renderIdeas();
      resetIdeaForm();
    }

    async function handleSaveIdea() {
      const titleInput = document.getElementById("idea-title-input");
      const bodyInput = document.getElementById("idea-body-input");
      const t = translations[currentLang];

      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();

      if (!currentCode || !supabaseClient) {
        alert(
          currentLang === "ko"
            ? "Î®ºÏ†Ä Ï†ëÍ∑º ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."
            : "Please enter an access code first."
        );
        return;
      }

      if (!title && !body) {
        titleInput.focus();
        return;
      }

      if (editingIdeaId) {
        const { data, error } = await supabaseClient
          .from("ideas")
          .update({
            title,
            body
          })
          .eq("id", editingIdeaId)
          .eq("code", currentCode)
          .select()
          .single();

        if (error) {
          console.error("Update idea error:", error);
          alert(
            "Failed to update idea: " + (error.message || "Unknown error")
          );
          return;
        }

        const idx = ideas.findIndex((i) => i.id === editingIdeaId);
        if (idx !== -1) ideas[idx] = data;
      } else {
        const nowIso = new Date().toISOString();
        const { data, error } = await supabaseClient
          .from("ideas")
          .insert([
            {
              code: currentCode,
              title,
              body,
              created_at: nowIso
            }
          ])
          .select()
          .single();

        if (error) {
          console.error("Insert idea error:", error);
          alert(
            "Failed to save idea: " + (error.message || "Unknown error")
          );
          return;
        }

        ideas.unshift(data);
      }

      renderIdeas();
      resetIdeaForm();
    }

    function exportDataAsText() {
      const t = translations[currentLang];
      sortEntries();

      const now = new Date();
      const lines = [];

      lines.push(t.export_title || "BackLog export");
      lines.push(`Access code: ${currentCode || "(none)"}`);
      lines.push(`Generated at: ${now.toLocaleString()}`);
      lines.push("");
      lines.push(t.export_entries_header || "=== Entries ===");
      lines.push("");

      if (entries.length === 0) {
        lines.push(t.export_no_entries || "(No entries recorded)");
      } else {
        entries.forEach((e, index) => {
          const created = new Date(e.created_at);
          lines.push(`${t.export_entry || "Entry"} #${index + 1}`);
          lines.push(
            `  ${t.export_date || "Date"}: ${e.date} (${formatDisplayDate(
              e.date
            )})`
          );
          lines.push(
            `  ${t.export_logged_at || "Logged at"}: ${created.toLocaleString()}`
          );
          lines.push(
            `  ${t.export_overall_pain || "Overall pain"}: ${painToLabel(
              e.pain
            )}`
          );
          lines.push(`  ${t.export_activity || "Activity / Symptom"}:`);
          lines.push(`    ${e.activity || "-"}`);
          lines.push(`  ${t.export_treatment || "Treatment / Meds"}:`);
          lines.push(`    ${e.treatment || "-"}`);
          lines.push(`  ${t.export_feeling || "Feeling / Reflection"}:`);
          lines.push(`    ${e.feeling || "-"}`);
          lines.push("");
        });
      }

      lines.push("");
      lines.push(t.export_ideas_header || "=== Ideas ===");
      lines.push("");

      if (ideas.length === 0) {
        lines.push(t.export_no_ideas || "(No ideas saved)");
      } else {
        ideas
          .slice()
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .forEach((idea, idx) => {
            const created = new Date(idea.created_at);
            lines.push(`${t.export_idea || "Idea"} #${idx + 1}`);
            lines.push(
              `  ${t.export_title_label || "Title"}: ${
                idea.title || t.idea_untitled || "(Untitled idea)"
              }`
            );
            lines.push(
              `  ${t.export_saved_at || "Saved at"}: ${created.toLocaleString()}`
            );
            lines.push(`  ${t.export_details || "Details"}:`);
            (idea.body || "-")
              .split("\n")
              .forEach((line) => lines.push(`    ${line}`));
            lines.push("");
          });
      }

      const blob = new Blob([lines.join("\n")], {
        type: "text/plain;charset=utf-8"
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `backlog_export_${formatDateKey(now)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function initAppForCode(code) {
      currentCode = code;
      const codeTag = document.getElementById("code-tag");
      codeTag.style.display = "inline-block";
      codeTag.textContent = `Code: ${code}`;

      entries = [];
      ideas = [];

      await loadData();
      sortEntries();
      renderEntries();
      renderIdeas();

      const now = new Date();
      currentMonth = now.getMonth();
      currentYear = now.getFullYear();
      selectedDate = formatDateKey(now);
      renderCalendar();
      renderDayDetails();

      closeEntrySheet();
      resetIdeaForm();
    }

    async function handleEnterCode() {
      const input = document.getElementById("code-input");
      const errorEl = document.getElementById("code-error");
      const t = translations[currentLang];
      let raw = (input.value || "").trim();
      raw = raw.replace(/\s+/g, "");
      const normalized = raw.toUpperCase();
      const valid = /^[0-9]{4}[A-Z]{3}$/.test(normalized);

      if (!valid) {
        errorEl.textContent =
          t.intro_error_format ||
          "Please enter 4 digits + 3 letters (e.g. 1234ABC).";
        return;
      }

      errorEl.textContent = "";
      input.value = normalized;

      const overlay = document.getElementById("intro-overlay");
      overlay.style.display = "none";

      await initAppForCode(normalized);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // Language buttons
      const langButtons = document.querySelectorAll(".lang-btn");
      langButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          langButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentLang = btn.getAttribute("data-lang") || "en";
          applyTranslations();
        });
      });

      applyTranslations();

      const tabButtons = document.querySelectorAll(".tab");
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          showTab(btn.dataset.tab);
        });
      });

      document
        .getElementById("btn-add-entry")
        .addEventListener("click", () => openEntrySheetForNew());

      document
        .getElementById("btn-cancel-entry")
        .addEventListener("click", closeEntrySheet);

      document
        .getElementById("btn-save-entry")
        .addEventListener("click", () => {
          handleSaveEntry();
        });

      document
        .getElementById("entry-sheet-backdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "entry-sheet-backdrop") {
            closeEntrySheet();
          }
        });

      document
        .getElementById("btn-delete-entry")
        .addEventListener("click", () => {
          if (editingEntryId) deleteEntry(editingEntryId);
        });

      document
        .getElementById("btn-add-idea")
        .addEventListener("click", () => {
          handleSaveIdea();
        });

      document
        .getElementById("btn-delete-idea")
        .addEventListener("click", () => {
          if (editingIdeaId) deleteIdea(editingIdeaId);
        });

      document
        .getElementById("btn-export")
        .addEventListener("click", exportDataAsText);

      const painOpts = document.querySelectorAll(".pain-option");
      painOpts.forEach((opt) => {
        opt.addEventListener("click", () => {
          setPainSelection(opt.dataset.pain);
        });
      });

      document
        .getElementById("btn-prev-month")
        .addEventListener("click", () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          renderCalendar();
          renderDayDetails();
        });

      document
        .getElementById("btn-next-month")
        .addEventListener("click", () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          renderCalendar();
          renderDayDetails();
        });

      document.getElementById("btn-today").addEventListener("click", () => {
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
        selectedDate = formatDateKey(today);
        renderCalendar();
        renderDayDetails();
      });

      document
        .getElementById("btn-enter-app")
        .addEventListener("click", () => {
          handleEnterCode();
        });

      document
        .getElementById("code-input")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            handleEnterCode();
          }
        });

      document.getElementById("code-tag").addEventListener("click", () => {
        const overlay = document.getElementById("intro-overlay");
        const input = document.getElementById("code-input");
        const errorEl = document.getElementById("code-error");

        overlay.style.display = "flex";
        input.value = currentCode || "";
        errorEl.textContent = "";
      });
    });
  </script>
</body>
</html>
